<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>ConvertDate() - MyHealtheVet PHR FHIR API v0.2.5</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
<link href="assets/css/vha-ig-template.css" rel="stylesheet"/>



    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="fhir-logo" sizes="144x144" href="assets/ico/icon-fhir-144.png"/>
    <link rel="fhir-logo" sizes="114x114" href="assets/ico/icon-fhir-114.png"/>
    <link rel="fhir-logo" sizes="72x72" href="assets/ico/icon-fhir-72.png"/>
    <link rel="fhir-logo" href="assets/ico/icon-fhir-57.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"5"}
    h3,h4,h5,h6{--heading-prefix:"5"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->
        <!-- Placeholder for child template header declarations -->

<div id="va-nav"> 
     <a id="va-logo" no-external="true" href="https://va.gov">
     <img height="50" alt="VA Organization" src="assets/images/va-header-logo.png"/>
     </a>
	 </div>

        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">MyHealtheVet PHR FHIR API</span>
            <br/>
            <span style="display:inline-block;">0.2.5 - ci-build



  <img alt="United States of America flag" src="assets/images/usa.svg" height="16" title="United States of America"/>


            </span>
          </p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <!-- menu.xml  -->

<ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <li>
    <a href="index.html">Home</a>
  </li>
  <li>
    <a href="api.html">API</a>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Vista Mapping
      <b class="caret"></b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="background.html">background</a>
      </li>
      <li>
        <a href="background.html#allergy">Allergy</a>
      </li>
      <li>
        <a href="background.html#chem-hem">Chem-Hem</a>
      </li>
      <li>
        <a href="background.html#condition">Condition</a>
      </li>
      <li>
        <a href="background.html#ecg">ECG</a>
      </li>
      <li>
        <a href="background.html#immunization">Immunization</a>
      </li>
      <li>
        <a href="background.html#labreport">LabReport</a>
      </li>
      <li>
        <a href="background.html#notes">Notes</a>
      </li>
      <li>
        <a href="background.html#radiology">Radiology</a>
      </li>
      <li>
        <a href="background.html#vital-sign">Vital-Sign</a>
      </li>
      <li>
        <a href="utility.html">Utility</a>
      </li>
      <li>
        <a href="ConvertDate.html">ConvertDate</a>
      </li>
      <li>
        <a href="identifier.html">Id vs Identifier</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="testplan.html">Test Plan</a>
  </li>
  <li>
    <a href="artifacts.html">Artifacts</a>
  </li>
  <li>
    <a href="downloads.html">Downloads</a>
  </li>
</ul>
            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><b>ConvertDate()</b></li>

          <span style="float:right;">

            <a href="utility.html">&lt;prev</a> | 

            <a href="#bottom">bottom</a>

          | <a href="identifier.html">next&gt;</a>

          </span>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">MyHealtheVet PHR FHIR API - Local Development build (v0.2.5). See the <a href="https://department-of-veterans-affairs.github.io/mhv-fhir-phr-mapping/history.html">Directory of published versions</a></p><!--EndReleaseHeader-->
  <h2>ConvertDate()</h2>
  





  <table class="colsi">
    <tr>
  
      <td>
        <i>Page standards status:</i> <a href="http://hl7.org/fhir/R4/versions.html#std-process" title="Standard Status">Informative</a>
        
      </td>
  
  
    </tr>
  </table>








    <p><!-- white space is critical inside of capture --></p>
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#fileman-date" id="markdown-toc-fileman-date">Fileman Date</a></li>
  <li><a href="#hl7-timestamp" id="markdown-toc-hl7-timestamp">HL7 timestamp</a></li>
  <li><a href="#clinicalprocedureto-timestamp" id="markdown-toc-clinicalprocedureto-timestamp">clinicalProcedureTO timestamp</a></li>
  <li><a href="#other-formats" id="markdown-toc-other-formats">other formats</a></li>
  <li><a href="#when-no-timezone" id="markdown-toc-when-no-timezone">when no timezone</a></li>
</ul>

</div>
<p>There appears to be different formats of timestamps. First is Fileman Date, HL7 date time, and ClinicalProcedureTO.timestamp</p>

<p>For MVP we will focus on “Best Effort” translation into a <a href="http://hl7.org/fhir/R4/datatypes.html#dateTime">FHIR DateTime</a> datatype. The specific problem that we have is that often the data comes to us without a TimeZone, and FHIR requires that a timezone is given if a time is given. Within the source Vista it is understood what timezone would be used. Yet even a given timezone for a given Vista is not sufficient given that some Vista servers span timezones.</p>

<blockquote>
  <p>st6aid is the medical center divisions. under one VAMC you can have multiple divisions. kind of one to many relationship. THE PROBLEM THAT we encounter (most of the times) is that not all st6aids live under the same TZ to which their parent facilities are living. e.g. Nashville TN is in Central but Knoxville, TN is in Eastern. but Knoxville falls under Nashville. Thats why st2aid’s TZ info is so vital.</p>
</blockquote>

<ul>
  <li>We will convert to Date</li>
  <li>If we are given a timezone, then we will include the time and timezone</li>
  <li>If we can’t determine the timezone, then will not include the time</li>
</ul>

<p>Future might be different</p>
<ul>
  <li>We do have algorithm in MHV that is used in Appointments, but it is not clear that this fully supports all the timestamps outside of the scope of Appointments. So this would need to be made more robust. Including that this does not yet support fileman format, or proper HL7 v2 format</li>
  <li>We could implement time conversion as a service. Concern would be on how performant that is.</li>
</ul>

<h3 id="fileman-date">Fileman Date</h3>

<p>Input: Fileman Date</p>

<p>Return: FHIR DateTime</p>

<p>Given that the Fileman date is slightly different than HL7. The conversion is simple. The most important part is that the first three digits are the number of years since 1700.</p>

<p>See <a href="http://www.vistapedia.com/index.php/Date_formats">FileMan date</a></p>

<p>Here is XSLT</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="nt">&lt;xsl:transform</span> <span class="na">xmlns:xsl=</span><span class="s">"http://www.w3.org/1999/XSL/Transform"</span> <span class="na">version=</span><span class="s">"2.0"</span> <span class="nt">&gt;</span>
<span class="nt">&lt;xsl:template</span> <span class="na">name=</span><span class="s">"fileman-to-datetime"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;xsl:param</span> <span class="na">name=</span><span class="s">"fileman-date"</span> <span class="nt">/&gt;</span>
  
  <span class="c">&lt;!-- only handles 3 digit year based on 1700 --&gt;</span>
  <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"year"</span> <span class="na">select=</span><span class="s">"format-number(number(substring($fileman-date, 1, 3)) + 1700, '0000')"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"month"</span> <span class="na">select=</span><span class="s">"substring($fileman-date, 4, 2)"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"day"</span> <span class="na">select=</span><span class="s">"substring($fileman-date, 6, 2)"</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;xsl:choose&gt;</span>
    <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">"not(string-length($fileman-date) &gt; 8)"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"concat($year, '-', $month, '-', $day)"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/xsl:when&gt;</span> 
    <span class="nt">&lt;xsl:otherwise&gt;</span>
      <span class="nt">&lt;xsl:variable</span> <span class="na">name=</span><span class="s">"time"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"format-number(number(substring($fileman-date, 9, 2)), '00')"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;xsl:choose&gt;</span>
        <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">"string-length($fileman-date) &gt; 10"</span><span class="nt">&gt;</span>
          <span class="nt">&lt;xsl:text&gt;</span>:<span class="nt">&lt;/xsl:text&gt;</span>
          <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"format-number(number(substring($fileman-date, 11, 2)), '00')"</span> <span class="nt">/&gt;</span>
          <span class="nt">&lt;xsl:choose&gt;</span>
            <span class="nt">&lt;xsl:when</span> <span class="na">test=</span><span class="s">"string-length($fileman-date) &gt; 12"</span><span class="nt">&gt;</span>
              <span class="nt">&lt;xsl:text&gt;</span>:<span class="nt">&lt;/xsl:text&gt;</span>
              <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"format-number(number(substring($fileman-date, 13, 2)), '00')"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/xsl:when&gt;</span>
            <span class="nt">&lt;xsl:otherwise&gt;</span>
              <span class="nt">&lt;xsl:text&gt;</span>:00<span class="nt">&lt;/xsl:text&gt;</span>
            <span class="nt">&lt;/xsl:otherwise&gt;</span>
          <span class="nt">&lt;/xsl:choose&gt;</span>
        <span class="nt">&lt;/xsl:when&gt;</span>
        <span class="nt">&lt;xsl:otherwise&gt;</span>
          <span class="nt">&lt;xsl:text&gt;</span>:00:00<span class="nt">&lt;/xsl:text&gt;</span>
        <span class="nt">&lt;/xsl:otherwise&gt;</span>
      <span class="nt">&lt;/xsl:choose&gt;</span>
    <span class="nt">&lt;/xsl:variable&gt;</span>
    <span class="nt">&lt;xsl:value-of</span> <span class="na">select=</span><span class="s">"concat($year, '-', $month, '-', $day, 'T', $time, 'Z')"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/xsl:otherwise&gt;</span>
  <span class="nt">&lt;/xsl:choose&gt;</span>
<span class="nt">&lt;/xsl:template&gt;</span>
<span class="nt">&lt;/xsl:transform&gt;</span>
</code></pre></div></div>

<h3 id="hl7-timestamp">HL7 timestamp</h3>

<p>Chem-Hem literal timestamps are following HL7 and do include a timezone offset.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         <span class="nt">&lt;reportCompleteDate&gt;</span>
            <span class="nt">&lt;literal&gt;</span>20201029132952-0500<span class="nt">&lt;/literal&gt;</span>
         <span class="nt">&lt;/reportCompleteDate&gt;</span>
</code></pre></div></div>

<h3 id="clinicalprocedureto-timestamp">clinicalProcedureTO timestamp</h3>

<p>This seems to be formatted starting with three character month:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;timestamp&gt;</span>DEC 2,1998@10:01:13<span class="nt">&lt;/timestamp&gt;</span>
</code></pre></div></div>

<h3 id="other-formats">other formats</h3>

<p>Experience with the production system there are many other date/time formats we must consider. Consider that this does not include the above formats</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	private static final MHVDateFormat FORMATS[] = {
		new MHVDateFormat("yyyyMMddHHmmss",false),
		new MHVDateFormat("yyyyMMddHHmm",false),
		new MHVDateFormat("yyyyMMddHHmmssZ", false),
		new MHVDateFormat("yyyyMMddHHmmZ", false),
		new MHVDateFormat("yyyyMMdd", true),
		new MHVDateFormat("MM/dd/yyyy", true),
		new MHVDateFormat("M/d/yyyy", true),
		new MHVDateFormat("MMddyyyy", true),
		new MHVDateFormat("M-d-yyyy", true),
		new MHVDateFormat("yyyy-MM-dd", true),
		new MHVDateFormat("MMM d yyyy", true),
		new MHVDateFormat("d MMM yyyy", true),
		new MHVDateFormat("MMM d, yyyy", true),
		new MHVDateFormat("MMM d,yyyy", true),
		new MHVDateFormat("MMMMM d yyyy", true),
		new MHVDateFormat("d MMMMM yyyy", true),
		new MHVDateFormat("dd-MMM-yyyy", true),
		new MHVDateFormat("SyyMMdd.HHmmss", false),
		new MHVDateFormat("yyyyMMdd.HHmmss", false),
		new MHVDateFormat("SyyMMdd.kkmmss", false),
		new MHVDateFormat("MMM d,yyyy@HH:mm:ss", false),
		new MHVDateFormat("MMM d,yyyy@HH:mm:ss", false),//MAR 8,2005@15:09:02 (EKG)
		new MHVDateFormat("dd MMM yyyy @ HHmm", false)//21 Jun 2012 @ 1200
	};
</code></pre></div></div>

<h3 id="when-no-timezone">when no timezone</h3>

<p>TODO: Likely when there is no timezone, it was local time for that Vista.</p>

<ul>
  <li>should just drop the time, keeping only the date.</li>
  <li>presume eastern time.</li>
  <li>lookup in a table what timezone that vista lives in.</li>
</ul>




</div>
        </div>  <!-- /inner-wrapper -->
      </div>  <!-- /row -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-content -->

  <script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <a name="bottom"> </a>
  <div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
    <div class="container">  <!-- container -->

      <div style="background-color:var(--footer-nav-bg-color)">
        <table style="width:100%">
          <tbody>
            <tr>
              <td style="text-align:left">&#xA0;

                <a href="utility.html">&lt;prev</a>

              </td>
              <td style="text-align:center">
                <a href="#top">top</a>
              </td>
              <td style="text-align:right">&#xA0;

                <a href="identifier.html">next&gt;</a>

              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="inner-wrapper">
        <p>
          IG &#169; 2022+ <a style="color:var(--footer-hyperlink-text-color)" href="http://va.gov">VA Digital Services</a>.  Package va.mhv.fhir.phr#0.2.5 based on <a style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Fri, Oct 6, 2023 11:35-0500">2023-10-06</span>
          <br/>
          <span style="color: var(--footer-highlight-text-color)">
                      Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                  | <a style="color: var(--footer-hyperlink-text-color)" target="_blank" href="https://github.com/department-of-veterans-affairs/mhv-fhir-phr-mapping/issues/new/choose">New Issue</a> | <a style="color: var(--footer-hyperlink-text-color)" target="_blank" href="https://github.com/department-of-veterans-affairs/mhv-fhir-phr-mapping/issues">Issues</a>
                
          </span>
        </p>
      </div>  <!-- /inner-wrapper -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
    <div class="container">  <!-- container -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-post-footer -->
  
  <!-- JS and analytics only. -->
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
  <script type="text/javascript" src="assets/js/respond.min.js"> </script>
  <script type="text/javascript" src="assets/js/anchor.min.js"> </script>
  <script type="text/javascript" src="assets/js/clipboard.min.js"> </script>
  <script type="text/javascript" src="assets/js/clipboard-btn.js"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
<!-- feedback form - Google forms -->
<!-- v0.1, 2021-01-09 -->


  
    
  


  
    
  



<!-- / feedback form  -->

  <!-- Analytics Below
  ================================================== -->
  </body>
</html>

