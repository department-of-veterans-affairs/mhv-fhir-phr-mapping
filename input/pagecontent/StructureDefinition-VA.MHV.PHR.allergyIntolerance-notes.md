
- The [mock example](https://github.com/department-of-veterans-affairs/mhv-fhir-phr-mapping/blob/main/mocks/allergies.xml) 
- Received from HDR
- maps to [intoleranceConditions](https://github.com/department-of-veterans-affairs/mhv-np-cds-wsclient/blob/development/src/main/resources/xsd/templates/MHVIntoleranceConditionRead40011/template/MHVIntoleranceConditionRead40011.xsd) schema. 
- [mapping to HDR](StructureDefinition-VA.MHV.PHR.allergyIntolerance-mappings.html#mappings-for-hdr-allergy-to-mhv-fhir-phr-intolerancecondition)
- [Vivian Allergy 120.8](https://vivian.worldvista.org/dox/Global_XkdNUigxMjAuOA==.html)
- Should be based on [US-Core for AllergyIntolerance Resource profile]({{site.data.fhir.hl7fhiruscore}}/StructureDefinition-us-core-allergyintolerance.html)
- should have `meta.profile` set to `https://department-of-veterans-affairs.github.io/mhv-fhir-phr-mapping/StructureDefinition/VA.MHV.PHR.allergyIntolerance` to indicate the intent to be compliant with this profile
- identifier
  - seems most of the time there is a `intoleranceCondition.recordIdentifier.namespaceId`. this should be used if it is provided
  - else there is an typical TOid slice with the value prefix of `AllergyTO.`
- Using `active` and `entered-in-error` to support normal resource lifecycle.
  - a `verificationStatus` will be set to `entered-in-error` when `status` is `E`
  - a `clinicalStatus` will be set to `active` if the `status` is `F`
  - Thus query needs to look for [entries NOT marked `entered-in-error`](StructureDefinition-VA.MHV.PHR.allergyIntolerance.html)
- a `code.text` which tells you what the patient is allergic to
- `category` derived from `.allergyType`
  - `D` -> #medication
  - `F` -> #food
  - `O` -> #environment
  - multiple codes are multiple category - for example: `DF` -> both #medication and #food
- `reaction.reaction.code` seems to be a number
  - if it is a 7 digit number, then it is a VUID and system=`urn:oid:2.16.840.1.113883.6.233`
  - else it is likely a SNOMED
- `informationSourceCategory` contains one of two values
  - `OBSERVED` shall be mapped to extension[observedHistoric].valueCode=`o`
  - `HISTORICAL` shall be mapped to extension[observedHistoric].valueCode=`h`
- `facilityIdentifier` is where the allergy was first recorded (The VISN number).
  - logical to put this into `.recorder`, but that doesn't support a Organization reference
  - use alternate-reference extension on the recorder, with a Organization holding the facilityIdentifier.
    - `{{site.data.fhir.path}}StructureDefinition/alternate-reference`
  - populate the Organization.name from internal MHV table that is manually managed to hold human readable names given a DNS style identifier that we get in the HDR feed.
  - contained Organization
    - if changed to not contained, in order to support _include, we must define a search parameter against alternate-reference so that can be used in search `_include`.
- do not map `drugClass`
- confirmed vs unconfirmed
  - Vista has a "VERIFIED" but this does not come thru HDR.

#### Business Rules

- Ignore those without a facility
- Ignore those without an id
- no hold period
